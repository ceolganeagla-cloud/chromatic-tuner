 <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Ceol Gan Eagla â€” Tuner</title>
<meta name="theme-color" content="#0b1220">
<style>
  :root{ --bg:#0b1220; --panel:#0f1a2e; --ink:#e8f0ff; --muted:#a9b8d6; --ok:#22c55e; --accent:#1f9cf0; --line:#1f2f4c; }
  *{box-sizing:border-box} html,body{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;background:radial-gradient(900px 520px at 50% -20%, #112034 20%, var(--bg) 60%) no-repeat, var(--bg);color:var(--ink)}
  .wrap{max-width:960px;margin:0 auto;padding:10px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .brandCard{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:14px;background:linear-gradient(180deg,#12361f,#0f2a1b);border:1px solid #1b3a2a;box-shadow:0 6px 16px rgba(0,0,0,.35)}
  .brandLogo{width:36px;height:36px;border-radius:8px;background:#0b1220;border:1px solid #27435e;overflow:hidden;display:grid;place-items:center}
  .brandLogo img{width:100%;height:100%;object-fit:cover}
  .brandText{line-height:1.05}
  .brandTitle{font-weight:800;letter-spacing:.2px;font-size:16px}
  .brandSub{font-size:11px;color:#c8d7f5;opacity:.85}
  .flag{font-size:16px;margin-left:6px}
  .controls{display:flex;gap:8px;margin-left:auto}
  button{font-size:14px;padding:8px 12px;border-radius:12px;border:1px solid #1a2a48;background:#13213a;color:var(--ink);cursor:pointer}
  button.primary{background:#123a20;border-color:#1c5c34}
  button.danger{background:#311a1a;border-color:#512626}
  button:disabled{opacity:.5;cursor:not-allowed}
  .card{background:var(--panel);border:1px solid #1a2946;border-radius:16px;padding:10px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .block{background:#0d1b2f;border:1px solid #1a2946;border-radius:12px;padding:10px;margin-bottom:10px}
  .spHead{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .spTitle{font-size:12px;color:var(--muted)}
  .rows{display:flex;flex-direction:column;gap:8px}
  .srow{display:grid;grid-template-columns:54px 1fr 100px;gap:10px;align-items:center;padding:8px;border-radius:10px;background:#0c1b31;border:1px solid #1a2a48}
  .srow.in{background:#0f2a1e;border-color:#1f6b3f}
  .sName{font-weight:800;font-size:16px}
  .sBar{position:relative;height:8px;background:#223654;border-radius:999px;overflow:hidden}
  .sBar::before{content:"";position:absolute;left:50%;top:0;width:2px;height:100%;background:#8ba1c7;opacity:.7;transform:translateX(-50%)}
  .sDot{position:absolute;top:50%;width:14px;height:14px;border-radius:50%;background:#c6d6f4;border:2px solid #ffffff;transform:translate(-50%,-50%);transition:left .06s linear, background .12s, border-color .12s}
  .srow.flat .sDot,.srow.sharp .sDot{background:#f7c3c3;border-color:#ef9a9a}
  .srow.in .sDot{background:#b8ffd0;border-color:#22c55e}
  .sStatus{font-weight:700;color:#9fb0d0;text-align:right;font-size:12px}
  .srow.in .sStatus{color:#bff3d1}
  .readouts{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .chip{background:#0f213a;border:1px solid #1b2a46;border-radius:10px;padding:8px;text-align:center}
  .chip.ok{background:#0f2a1e;outline:2px solid var(--ok)}
  .lbl{display:block;font-size:12px;color:var(--muted);margin-bottom:2px}
  .val{font-size:18px;font-weight:800;letter-spacing:.2px}
  .fine{font-size:12px;color:#9fb0d0}
  .controlsRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .seg{background:#0e203a;border:1px solid #1b2a46;border-radius:10px;padding:8px}
  .miniBtns{display:flex;gap:6px;flex-wrap:wrap}
  .miniBtns button, select{font-size:14px;background:#0c1b31;color:var(--ink);border:1px solid #1a2a48;border-radius:8px;padding:6px 8px}
  .miniBtns button.active{outline:2px solid var(--accent)}
  footer{margin:10px 0 4px;color:#9fb0d0;text-align:center;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brandCard">
        <div class="brandLogo"><img src="Logo.png" alt="Ceol Gan Eagla"></div>
        <div class="brandText">
          <div class="brandTitle">Ceol Gan Eagla</div>
          <div class="brandSub">Chromatic Tuner</div>
        </div>
        <div class="flag" title="Ireland">ðŸ‡®ðŸ‡ª</div>
      </div>
      <div class="controls">
        <button id="startBtn" class="primary">Start</button>
        <button id="stopBtn" class="danger" disabled>Stop</button>
      </div>
    </header>

    <section class="card">
      <div class="block">
        <div class="spHead">
          <div class="spTitle">Strings â€¢ <span id="spTuning">EADGBE</span></div>
        </div>
        <div class="rows" id="rows"></div>

        <div class="readouts">
          <div id="statusChip" class="chip"><span class="lbl">Status</span><span id="status" class="val">Stopped</span></div>
          <div class="chip"><span class="lbl">Note</span><span id="note" class="val">â€”</span><span id="cents" class="fine">Â±0 cents</span></div>
          <div class="chip"><span class="lbl">Frequency</span><span id="freq" class="val">0.00 Hz</span></div>
        </div>

        <div class="controlsRow">
          <div class="seg">
            <div class="lbl">Reference A4</div>
            <div class="miniBtns" id="aBtns"></div>
          </div>
          <div class="seg">
            <div class="lbl">Instrument</div>
            <select id="instrument"></select>
            <div id="altTunings" class="miniBtns" style="margin-top:6px"></div>
          </div>
        </div>
      </div>
    </section>

    <footer>Â© GearÃ³id MacUaid â€” Ceol Gan Eagla â€” 2025</footer>
  </div>

<script>
/* ===== Data ===== */
const INSTRUMENTS={
  "Guitar":{tunings:{"EADGBE":["E2","A2","D3","G3","B3","E4"]}},
  "Violin":{tunings:{"GDAE":["G3","D4","A4","E5"]}},
  "Mandolin":{tunings:{"GDAE":["G3","D4","A4","E5"]}},
  "Banjo":{tunings:{"gDGBD":["G4","D3","G3","B3","D4"]}},
  "Ukulele":{tunings:{"GCEA":["G4","C4","E4","A4"]}},
  "Bass":{tunings:{"EADG":["E1","A1","D2","G2"]}},
  "Bouzouki":{tunings:{"GDAD":["G2","D3","A3","D4"],"GDAE":["G2","D3","A3","E4"],"ADAD":["A2","D3","A3","D4"]}},
  "Chromatic":{tunings:{"â€”":[]}}
};
/* ===== Elements ===== */
const rowsEl=document.getElementById('rows'), spTuning=document.getElementById('spTuning');
const instrumentSel=document.getElementById('instrument'), altTuningsDiv=document.getElementById('altTunings');
const statusEl=document.getElementById('status'), statusChip=document.getElementById('statusChip');
const freqEl=document.getElementById('freq'), noteEl=document.getElementById('note'), centsEl=document.getElementById('cents');
const startBtn=document.getElementById('startBtn'), stopBtn=document.getElementById('stopBtn'), aBtns=document.getElementById('aBtns');

/* ===== Note math ===== */
let A4=440;
function noteToMidiName(m){const names=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return names[m%12]+(Math.floor(m/12)-1)}
function midiToFreq(m){return A4*Math.pow(2,(m-69)/12)}
function noteHz(note){const m=note.match(/^([A-G]#?)(-?\d)$/);const map={"C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11};const i=map[m[1]],o=+m[2];return midiToFreq((o+1)*12+i)}
function centsFrom(f,target){return 1200*Math.log2(f/target)}

/* ===== Build UI ===== */
[438,439,440,441,442,443,444].forEach(v=>{const b=document.createElement('button');b.textContent=v;b.className='aRef';if(v===440)b.classList.add('active');b.onclick=()=>{[...aBtns.children].forEach(x=>x.classList.remove('active'));b.classList.add('active');A4=v;resetState();buildRows();};aBtns.appendChild(b);});
for(const k of Object.keys(INSTRUMENTS)){const o=document.createElement('option');o.textContent=k;instrumentSel.appendChild(o);}
instrumentSel.value="Guitar";
let currentInstrument="Guitar", currentTuning=Object.keys(INSTRUMENTS["Guitar"].tunings)[0];

function buildRows(){
  rowsEl.innerHTML="";
  const notes=INSTRUMENTS[currentInstrument].tunings[currentTuning];
  spTuning.textContent=currentTuning;
  notes.forEach(n=>{const r=document.createElement('div');r.className='srow';r.dataset.note=n;r.innerHTML=`<div class="sName">${n}</div><div class="sBar"><div class="sDot" style="left:50%"></div></div><div class="sStatus">â€”</div>`;rowsEl.appendChild(r);});
}
function rebuildTunings(){
  currentInstrument=instrumentSel.value;
  const names=Object.keys(INSTRUMENTS[currentInstrument].tunings);
  if(!names.includes(currentTuning)) currentTuning=names[0];
  altTuningsDiv.innerHTML="";
  names.forEach(n=>{const b=document.createElement('button');b.textContent=n;b.className='aRef';if(n===currentTuning)b.classList.add('active');b.onclick=()=>{currentTuning=n;[...altTuningsDiv.children].forEach(x=>x.classList.remove('active'));b.classList.add('active');resetState();buildRows();};altTuningsDiv.appendChild(b);});
  buildRows();
}
instrumentSel.onchange=rebuildTunings; rebuildTunings();

/* ===== Audio & Pitch (YIN) ===== */
let audioCtx=null, analyser=null, data=null, mediaStream=null, rafId=null, running=false;
let noiseFloor=0.015;
function yinPitch(){
  if(!analyser) return {freq:null,conf:0};
  analyser.getFloatTimeDomainData(data);
  const N=data.length;
  let rms=0; for(let i=0;i<N;i++) rms+=data[i]*data[i];
  rms=Math.sqrt(rms/N); if(rms<noiseFloor) return {freq:null,conf:0};
  const maxTau=Math.floor(N/2);
  const diff=new Float32Array(maxTau);
  for(let tau=1;tau<maxTau;tau++){let s=0;for(let i=0;i<maxTau;i++){const d=data[i]-data[i+tau];s+=d*d;}diff[tau]=s;}
  const cmndf=new Float32Array(maxTau); cmndf[0]=1; let run=0;
  for(let tau=1;tau<maxTau;tau++){run+=diff[tau];cmndf[tau]=diff[tau]*tau/(run||1);}
  const thr=0.15; let tau=2; while(tau<maxTau && cmndf[tau]>thr) tau++;
  if(tau===maxTau) return {freq:null,conf:0};
  const t1=tau-1, t2=tau, t3=Math.min(tau+1,maxTau-1);
  const a=(cmndf[t1]+cmndf[t3]-2*cmndf[t2])/2, b=(cmndf[t3]-cmndf[t1])/2;
  const tauEst=t2 + (isFinite(a)&&a!==0? -b/(2*a):0);
  const f=audioCtx.sampleRate/tauEst, conf=1-cmndf[tau];
  if(f<20||f>5000) return {freq:null,conf:0};
  return {freq:f,conf};
}

/* ===== Lock-on State Machine =====
   IDLE -> CANDIDATE (if a note is within CAPTURE_CENTS for LOCK_FRAMES)
   CANDIDATE -> ACTIVE when stable enough
   ACTIVE stays locked to that string until it drifts outside RELEASE_CENTS for DROP_FRAMES
*/
const CAPTURE_CENTS = 80;   // only consider notes within Â±80Â¢ of some string to start
const RELEASE_CENTS = 120;  // drop lock if it goes beyond Â±120Â¢
const LOCK_FRAMES   = 6;    // need 6 consistent frames to lock
const DROP_FRAMES   = 12;   // need 12 bad frames to drop lock
const SMOOTH_ALPHA  = 0.35; // low-pass for cents

let state="IDLE";           // "IDLE" | "CANDIDATE" | "ACTIVE"
let candidate=null;         // {note,targetHz,count}
let active=null;            // {note,targetHz}
let smoothCents=0;
let badFrames=0;

function resetState(){
  state="IDLE"; candidate=null; active=null; smoothCents=0; badFrames=0;
  statusChip.classList.remove('ok'); statusEl.textContent="Stopped";
  freqEl.textContent='0.00 Hz'; noteEl.textContent='â€”'; centsEl.textContent='Â±0 cents';
  rowsEl.querySelectorAll('.srow').forEach(r=>{r.classList.remove('in','flat','sharp');r.querySelector('.sDot').style.left='50%';r.querySelector('.sStatus').textContent='â€”';});
}

/* nearest string in current tuning (returns {note,targetHz,cents,absCents}) */
function nearestString(f){
  const list=INSTRUMENTS[currentInstrument].tunings[currentTuning];
  if(!list||!list.length) return null;
  let best=null, bestAbs=1e9;
  list.forEach(n=>{const hz=noteHz(n); const c=Math.round(centsFrom(f,hz)); const ac=Math.abs(c); if(ac<bestAbs){best={note:n,targetHz:hz,cents:c,absCents:ac};bestAbs=ac;}});
  return best;
}

/* UI update for a specific row */
function updateRow(note,cents,inTune){
  const row=[...rowsEl.children].find(r=>r.dataset.note===note); if(!row) return;
  const dot=row.querySelector('.sDot'); const status=row.querySelector('.sStatus');
  const pos=Math.max(-50,Math.min(50,cents)); dot.style.left=`${pos+50}%`;
  row.classList.remove('in','flat','sharp');
  if(inTune){ row.classList.add('in'); status.textContent='In tune'; }
  else { status.textContent = cents<0?'Flat':'Sharp'; row.classList.add(cents<0?'flat':'sharp'); }
}
function clearNonActive(note){
  rowsEl.querySelectorAll('.srow').forEach(r=>{
    if(r.dataset.note!==note){ r.classList.remove('in','flat','sharp'); r.querySelector('.sDot').style.left='50%'; r.querySelector('.sStatus').textContent='â€”'; }
  });
}

/* ===== Main loop ===== */
let FBUF=[]; const MAXN=7; // median freq smoother
function median(a){const b=[...a].sort((x,y)=>x-y); return b[Math.floor(b.length/2)]}

function loop(){
  if(!running) return;
  const {freq,conf}=yinPitch();

  if(freq && conf>0.25){ // ignore weak/uncertain
    FBUF.push(freq); if(FBUF.length>MAXN) FBUF.shift();
    const fmed=median(FBUF);
    const near=nearestString(fmed);
    if(near){
      if(state==="IDLE"){
        // only start candidate if within capture window
        if(near.absCents<=CAPTURE_CENTS){
          state="CANDIDATE"; candidate={note:near.note,targetHz:near.targetHz,count:1};
        }
      }else if(state==="CANDIDATE"){
        // must stay near same string to build confidence
        if(near.note===candidate.note && near.absCents<=CAPTURE_CENTS){
          candidate.count++;
          if(candidate.count>=LOCK_FRAMES){
            state="ACTIVE"; active={note:candidate.note,targetHz:candidate.targetHz}; badFrames=0; smoothCents=0;
          }
        }else{
          // reset if it wandered to other note or too far
          candidate={note:near.note,targetHz:near.targetHz,count:1};
        }
      }else if(state==="ACTIVE"){
        // compute cents strictly against the locked string
        const c=Math.round(centsFrom(fmed,active.targetHz));
        smoothCents = (1-SMOOTH_ALPHA)*smoothCents + SMOOTH_ALPHA*c;
        const inTune = Math.abs(smoothCents)<=3;

        // UI for active only
        updateRow(active.note, Math.round(smoothCents), inTune);
        clearNonActive(active.note);

        // readouts
        statusEl.textContent = inTune ? "In tune" : (smoothCents<0?"Flat":"Sharp");
        statusChip.classList.toggle('ok', inTune);
        noteEl.textContent = active.note;
        centsEl.textContent = `${smoothCents>0?'+':''}${Math.round(smoothCents)} cents`;
        freqEl.textContent = `${fmed.toFixed(2)} Hz`;

        // drop lock if far off for several frames
        if(Math.abs(c)>RELEASE_CENTS || near.note!==active.note){
          badFrames++;
          if(badFrames>=DROP_FRAMES){
            state="IDLE"; active=null; candidate=null; FBUF.length=0;
            // clear UI to neutral
            statusChip.classList.remove('ok');
            statusEl.textContent="Listeningâ€¦";
            freqEl.textContent='0.00 Hz'; noteEl.textContent='â€”'; centsEl.textContent='Â±0 cents';
            rowsEl.querySelectorAll('.srow').forEach(r=>{r.classList.remove('in','flat','sharp'); r.querySelector('.sDot').style.left='50%'; r.querySelector('.sStatus').textContent='â€”';});
          }
        }else{
          badFrames=0;
        }
      }
    }
    // When candidate or idle, keep readouts neutral
    if(state!=="ACTIVE"){
      statusEl.textContent="Listeningâ€¦"; statusChip.classList.remove('ok');
      freqEl.textContent='0.00 Hz'; noteEl.textContent='â€”'; centsEl.textContent='Â±0 cents';
    }
  }else{
    // no valid pitch this frame
    if(state==="ACTIVE"){
      // count as bad frames toward drop
      badFrames++; if(badFrames>=DROP_FRAMES){ state="IDLE"; active=null; candidate=null; FBUF.length=0; rowsEl.querySelectorAll('.srow').forEach(r=>{r.classList.remove('in','flat','sharp'); r.querySelector('.sDot').style.left='50%'; r.querySelector('.sStatus').textContent='â€”';}); }
    }else{
      statusEl.textContent="Listeningâ€¦"; statusChip.classList.remove('ok');
    }
  }
  rafId=requestAnimationFrame(loop);
}

/* ===== Controls ===== */
async function start(){
  if(running) return; statusEl.textContent='Startingâ€¦'; startBtn.disabled=true;
  try{
    mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false,channelCount:1},video:false});
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const src=audioCtx.createMediaStreamSource(mediaStream);
    // light band-pass focuses on strings; tweak if needed
    const hp=audioCtx.createBiquadFilter(); hp.type="highpass"; hp.frequency.value=50;
    const lp=audioCtx.createBiquadFilter(); lp.type="lowpass"; lp.frequency.value=2000;
    src.connect(hp); hp.connect(lp);

    analyser=audioCtx.createAnalyser(); analyser.fftSize=8192; analyser.smoothingTimeConstant=0;
    lp.connect(analyser); data=new Float32Array(analyser.fftSize);

    // quick noise calibration
    await new Promise(res=>setTimeout(res,200));
    analyser.getFloatTimeDomainData(data); let s=0; for(let i=0;i<data.length;i++) s+=data[i]*data[i];
    noiseFloor=Math.max(0.01, Math.sqrt(s/data.length)*0.9);

    running=true; stopBtn.disabled=false; statusEl.textContent='Listeningâ€¦'; resetState(); loop();
  }catch(e){ console.error(e); statusEl.textContent='Mic blocked'; startBtn.disabled=false; }
}
async function stop(){
  running=false; stopBtn.disabled=true; startBtn.disabled=false;
  resetState(); cancelAnimationFrame(rafId);
  try{ if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop()); }catch(_){}
  mediaStream=null; try{ if(audioCtx && audioCtx.state!=='closed') await audioCtx.close(); }catch(_){}
  audioCtx=null; analyser=null; data=null;
}
startBtn.onclick=start; stopBtn.onclick=stop;
</script>
</body>
</html>

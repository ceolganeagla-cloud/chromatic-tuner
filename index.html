<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ceol Gan Eagla â€” Chromatic Tuner</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#006400">

<style>
  :root{
    --bg:#0b0f12; --panel:#111820; --ink:#eaf1f8; --muted:#9fb4c6;
    --accent:#22c55e; --warn:#ef4444; --gold:#ffd700; --green:#006400;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
  header{display:flex;align-items:center;gap:.75rem;padding:1rem;border-bottom:1px solid #1f2a36;background:linear-gradient(180deg,#0d141c,#0b0f12)}
  header img{width:42px;height:42px;border-radius:12px;border:2px solid rgba(255,255,255,.2)}
  h1{font-size:1.1rem;margin:0;letter-spacing:.3px}
  main{max-width:900px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
  .card{background:var(--panel);border:1px solid #1f2a36;border-radius:16px;padding:1rem;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .controls{display:grid;gap:.75rem;grid-template-columns:1fr;align-items:center}
  .row{display:flex;gap:.75rem;flex-wrap:wrap}
  button,.selectlike{appearance:none;background:#12202b;color:var(--ink);border:1px solid #1f2a36;border-radius:12px;padding:.8rem 1rem;font-weight:600;cursor:pointer}
  button:hover{outline:2px solid rgba(34,197,94,.25)}
  .selectlike{display:flex;align-items:center;gap:.5rem}
  select{background:transparent;color:var(--ink);border:none;outline:none;font-weight:600}
  .meter{height:10px;background:#0c141b;border-radius:999px;border:1px solid #1f2a36;overflow:hidden}
  .meter > div{height:100%;width:50%;background:linear-gradient(90deg,#f87171,#fde047,#34d399);transform-origin:left center;transition:width .12s linear}
  .note{display:flex;align-items:baseline;gap:1rem}
  .note .big{font-size:4rem;font-weight:800;line-height:1}
  .note .cents{font-variant-numeric:tabular-nums;font-weight:700}
  .status{min-height:1.5rem;color:var(--muted)}
  .strings{display:flex;gap:.5rem;flex-wrap:wrap}
  .chip{padding:.45rem .7rem;border-radius:999px;border:1px solid #263445;background:#0f1720;color:var(--muted);font-weight:700}
  .chip.active{border-color:var(--gold);color:var(--gold);background:rgba(255,215,0,.08)}
  footer{opacity:.8;text-align:center;padding:1rem;color:var(--muted)}
  @media(min-width:720px){ .controls{grid-template-columns:2fr 1fr} }
</style>
</head>
<body>
<header>
<img src="icons/icon-192.png" alt="Ceol Gan Eagla Logo">
  <div>
    <h1>Ceol Gan Eagla â€” Chromatic Tuner</h1>
    <small style="color:var(--muted)">Mic access required â€¢ Works offline after first load</small>
  </div>
</header>

<main>
  <section class="card controls">
    <div class="row">
      <button id="startBtn">ðŸŽ¤ Start Tuner</button>
      <div class="selectlike">
        <span>Instrument:</span>
        <select id="instrument">
          <option value="chromatic">Chromatic (Any)</option>
          <option value="fiddle">Fiddle / Mandolin (Gâ€“Dâ€“Aâ€“E)</option>
          <option value="guitar">Guitar Standard (Eâ€“Aâ€“Dâ€“Gâ€“Bâ€“E)</option>
          <option value="banjo4">Tenor Banjo GDAE</option>
          <option value="uke">Ukulele (Gâ€“Câ€“Eâ€“A)</option>
        </select>
      </div>
      <div class="selectlike">
        <span>Ref A:</span>
        <select id="refA">
          <option>440</option>
          <option>442</option>
          <option>415</option>
          <option>432</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="note">
        <div class="big" id="noteName">--</div>
        <div class="cents"><span id="cents">0</span> cents</div>
      </div>
    </div>

    <div class="meter"><div id="bar"></div></div>
    <div class="status" id="status">Waiting for inputâ€¦</div>
    <div class="strings" id="strings"></div>
  </section>

  <section class="card">
    <strong>Tips</strong>
    <ul>
      <li>Pluck a single string or play a sustained note close to the mic.</li>
      <li>Use the Instrument menu to highlight target strings.</li>
      <li>Green = in tune, Red = flat, Yellow = sharp.</li>
    </ul>
  </section>
</main>

<footer>Â© Ceol Gan Eagla â€” Be fearless, play in tune.</footer>

<script>
// --- Utility: tuning + pitch detection (auto-correlation) ---
const A4 = () => parseFloat(document.getElementById('refA').value) || 440;
function noteFromFrequency(freq){ return Math.round(12 * Math.log2(freq / A4()) + 69); }
function frequencyFromNoteNumber(note){ return A4() * Math.pow(2, (note-69)/12); }
function centsOffFromPitch(freq, note){ return Math.floor(1200 * Math.log2(freq / frequencyFromNoteNumber(note))); }

// Simple auto-correlation pitch detector
function autoCorrelate(buf, sampleRate) {
  let size = buf.length;
  let rms = 0;
  for (let i=0;i<size;i++){ let val = buf[i]; rms += val*val; }
  rms = Math.sqrt(rms/size);
  if (rms < 0.008) return -1; // too quiet

  let r1=0, r2=size-1, thres=0.2;
  for (let i=0; i<size/2; i++) if (Math.abs(buf[i])<thres) { r1=i; break; }
  for (let i=1; i<size/2; i++) if (Math.abs(buf[size-i])<thres){ r2=size-i; break; }
  buf = buf.slice(r1, r2);
  size = buf.length;

  let c = new Array(size).fill(0);
  for (let i=0; i<size; i++) for (let j=0; j<size-i; j++) c[i] = c[i] + buf[j]*buf[j+i];
  let d=0; while (c[d] > c[d+1]) d++;
  let maxval=-1, maxpos=-1;
  for (let i=d; i<size; i++){ if (c[i] > maxval){ maxval = c[i]; maxpos = i; } }
  let T0 = maxpos;
  if (T0 > 0){
    let x1=c[T0-1], x2=c[T0], x3=c[T0+1];
    let a = (x1 + x3 - 2*x2)/2;
    let b = (x3 - x1)/2;
    if (a) T0 = T0 - b/(2*a);
  }
  return sampleRate/T0;
}

// Instrument presets
const PRESETS = {
  chromatic: [],
  fiddle: ["G3","D4","A4","E5"],
  guitar: ["E2","A2","D3","G3","B3","E4"],
  banjo4: ["G3","D4","A4","E5"],
  uke: ["G4","C4","E4","A4"]
};
function midiToName(n){
  const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const name = names[n % 12];
  const oct = Math.floor(n/12)-1;
  return name + oct;
}
function nameToMidi(name){
  const re = /^([A-G]#?)(-?\\d)$/i;
  const idx = {"C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11};
  const m = name.match(re); if(!m) return null;
  return (parseInt(m[2])+1)*12 + idx[m[1].toUpperCase()];
}

function renderStrings(){
  const el = document.getElementById('strings');
  el.innerHTML = "";
  const preset = PRESETS[document.getElementById('instrument').value] || [];
  preset.forEach(n => {
    const d = document.createElement('div');
    d.className = "chip";
    d.dataset.midi = nameToMidi(n);
    d.textContent = n;
    el.appendChild(d);
  });
}
renderStrings();
document.getElementById('instrument').addEventListener('change', renderStrings);

let audioCtx, analyser, buf, source, rafId;
const NOTE_NAMES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

async function start(){
  if (audioCtx) return;
  document.getElementById('status').textContent = "Requesting microphoneâ€¦";
  const stream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:false, noiseSuppression:false}});
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  source = audioCtx.createMediaStreamSource(stream);
  source.connect(analyser);
  buf = new Float32Array(analyser.fftSize);
  document.getElementById('status').textContent = "Listeningâ€¦";
  tick();
}
document.getElementById('startBtn').addEventListener('click', start);

function highlightClosest(targetMidi){
  const chips = document.querySelectorAll('.chip');
  chips.forEach(c=>c.classList.remove('active'));
  if (targetMidi==null) return;
  let closest=null,closestEl=null;
  chips.forEach(c=>{
    const m = parseInt(c.dataset.midi,10);
    if (closest===null || Math.abs(m-targetMidi) < Math.abs(closest-targetMidi)){
      closest = m; closestEl = c;
    }
  });
  if (closestEl) closestEl.classList.add('active');
}

function tick(){
  analyser.getFloatTimeDomainData(buf);
  const pitch = autoCorrelate(buf, audioCtx.sampleRate);
  const noteEl = document.getElementById('noteName');
  const centsEl = document.getElementById('cents');
  const bar = document.getElementById('bar');
  const status = document.getElementById('status');

  if (pitch === -1 || !isFinite(pitch)){
    status.textContent = "Too quiet / no pitch detectedâ€¦";
    bar.style.width = "50%";
    requestAnimationFrame(tick);
    return;
  }

  const note = noteFromFrequency(pitch);
  const name = NOTE_NAMES[note % 12] + (Math.floor(note/12)-1);
  const cents = centsOffFromPitch(pitch, note);

  noteEl.textContent = name;
  centsEl.textContent = (cents>0?"+":"") + cents;

  const clamped = Math.max(-50, Math.min(50, cents));
  bar.style.width = (50 + clamped) + "%";
  bar.style.background = Math.abs(cents) < 5 ? "linear-gradient(90deg,#34d399,#10b981)" : (cents<0 ? "#f87171" : "#fde047");

  status.textContent = "Pitch â‰ˆ " + pitch.toFixed(2) + " Hz";
  highlightClosest(note);
  rafId = requestAnimationFrame(tick);
}

// Register service worker
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => navigator.serviceWorker.register("sw.js"));
}
</script>
</body>
</html>

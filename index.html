<!doctype html>
<html lang="en">
<head>
<!-- Ceol Gan Eagla Tuner — © 2025 Ceol Gan Eagla  All rights reserved. -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta charset="utf-8">
<title>Ceol Gan Eagla Tuner</title>

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<meta name="theme-color" content="#000000">

<style>
:root{
  --bg:#0b1220;--panel:#0f172a;--card:#0c1324;--ink:#eaf2ff;--muted:#a4b0c0;--line:#1f2a44;
  --ok:#22c55e;--low:#ff8a1f;--high:#ef4444;--bar:#111a2e;--bar-edge:#1a2744;
}
*{box-sizing:border-box}
html,body{
  height:100%;margin:0;background:var(--bg);color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  overflow:hidden;overscroll-behavior:none;
}
.wrap{
  display:grid;grid-template-rows:auto auto auto auto 1fr auto;gap:12px;
  height:100svh;max-height:100svh;padding:14px;overflow:hidden;
}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
h1{margin:0;font-size:clamp(18px,4.5vw,28px)}
button{
  appearance:none;border:1px solid var(--line);background:var(--panel);color:var(--ink);
  padding:10px 14px;border-radius:14px;font-weight:700;cursor:pointer;
}
button.toggle.start{background:#16a34a;color:#fff;border-color:#106c31}
button.toggle.stop{background:#b91c1c;color:#fff;border-color:#7f1212}
.badge{padding:8px 12px;border-radius:999px;background:var(--panel);border:1px solid var(--line);font-weight:700;color:var(--muted)}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
.instrument-btn{
  display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;
  background:var(--card);border:1px solid var(--line);cursor:pointer;font-weight:800;color:var(--ink)
}
.instrument-btn.active{outline:2px solid #3b82f6}
.instrument-btn.tuned{background:#0e2919;border-color:#1f8a4e}
select{
  appearance:none;border:1px solid var(--line);background:var(--card);color:var(--ink);
  padding:10px 12px;border-radius:12px;font-weight:700
}
.string-chip{
  padding:6px 10px;border:1px solid var(--line);background:var(--card);
  border-radius:999px;font-weight:800;color:var(--ink);min-width:44px;text-align:center
}
.string-chip.active{outline:2px solid #3b82f6}
.string-chip.tuned{background:#0e2919;border-color:#1f8a4e}
.bar{position:relative;height:36px;border-radius:999px;background:var(--bar);border:1px solid var(--bar-edge);overflow:hidden}
.pointer{position:absolute;top:50%;transform:translate(-50%,-50%);
  width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:18px solid #eaf2ff}
.note{font-size:clamp(28px,10vw,48px);font-weight:900}
.status{font-size:clamp(16px,4vw,22px);font-weight:900;padding:6px 12px;border-radius:12px;background:var(--card);border:1px solid var(--line);min-width:140px;text-align:center}
.status.low{color:var(--low)}
.status.high{color:var(--high)}
.status.ok{color:var(--ok)}
footer{text-align:center;color:var(--muted);font-size:12px}
.meter{height:8px;border-radius:999px;background:#1f2a44;overflow:hidden;width:180px;border:1px solid var(--line)}
.meter>div{height:100%;width:0;background:#3b82f6;transition:width .08s linear}
.metro{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.metro .dot{width:12px;height:12px;border-radius:50%;background:#2b3757;border:1px solid var(--line)}
.metro .dot.active{background:#eaf2ff}
.metro .dot.accent{background:#22c55e}
@media(max-height:740px){
  .wrap{padding:10px}.panel{padding:10px}.row{gap:8px}
  .badge,button,select{padding:8px 10px}
}
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <h1>Ceol Gan Eagla Tuner</h1>
    <div>
      <button id="toggleBtn" class="toggle start">Start Mic</button>
      <span class="badge" id="micStatus">Mic Off</span>
    </div>
  </header>

  <div class="panel">
    <div class="row">
      <div id="instrumentTray">
        <button class="instrument-btn active" data-inst="guitar">Guitar</button>
        <button class="instrument-btn" data-inst="violin">Violin</button>
        <button class="instrument-btn" data-inst="tenorbanjo">Tenor Banjo</button>
        <button class="instrument-btn" data-inst="mandolin">Mandolin</button>
        <button class="instrument-btn" data-inst="bouzouki">Bouzouki</button>
      </div>
      <div class="row">
        <label class="badge">Tuning</label><select id="tuningSelect"></select>
        <label class="badge">A4</label><select id="a4Select"></select><span class="badge" id="a4Show">A4 = 440</span>
        <div class="meter"><div id="levelBar"></div></div>
      </div>
    </div>
    <div class="row"><div id="tuningText" class="badge">E A D G B E</div></div>
    <div id="stringRow" class="row"></div>
  </div>

  <div class="panel">
    <div class="bar"><div class="pointer" id="pointer" style="left:50%"></div></div>
    <div style="text-align:center;margin-top:8px">
      <div class="note" id="note">—</div>
      <div class="status" id="status">Stopped</div>
    </div>
  </div>

  <div class="panel metro">
    <select id="sigSelect">
      <option value="4-4" selected>4/4</option><option value="6-8">6/8</option>
      <option value="3-4">3/4</option><option value="2-4">2/4</option>
    </select>
    <input id="bpmInput" type="number" min="30" max="240" value="100" style="width:70px">
    <button id="metroBtn">Metronome</button>
    <div id="metroDots" class="row"></div>
  </div>

  <footer>© 2025 Gearóid MacUaid — Ceol Gan Eagla</footer>
</div>

<script>
/* fit-to-screen auto-scale */
(function(){
  const root=document.getElementById('app');
  function fit(){
    if(!root)return;
    root.style.transform='none';root.style.width='';root.style.height='';
    const vw=innerWidth,vh=innerHeight,w=root.scrollWidth,h=root.scrollHeight;
    const s=Math.min(vw/w,vh/h,1);
    root.style.width=w+'px';root.style.height=h+'px';root.style.transform='scale('+s+')';
  }
  addEventListener('load',fit,{once:true});
  addEventListener('resize',fit);addEventListener('orientationchange',fit);
})();
</script>

<script>
(() => {
const NOTE_NAMES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const toggleBtn=document.getElementById('toggleBtn');
const micStatus=document.getElementById('micStatus');
const tray=document.getElementById('instrumentTray');
const tuningSelect=document.getElementById('tuningSelect');
const a4Select=document.getElementById('a4Select');
const a4Show=document.getElementById('a4Show');
const pointer=document.getElementById('pointer');
const noteEl=document.getElementById('note');
const statusEl=document.getElementById('status');
const tuningText=document.getElementById('tuningText');
const stringRow=document.getElementById('stringRow');
const levelBar=document.getElementById('levelBar');
const sigSelect=document.getElementById('sigSelect');
const bpmInput=document.getElementById('bpmInput');
const metroBtn=document.getElementById('metroBtn');
const metroDots=document.getElementById('metroDots');

const TUNINGS={
  guitar:{"E A D G B E":["E2","A2","D3","G3","B3","E4"]},
  violin:{"G D A E":["G3","D4","A4","E5"]},
  tenorbanjo:{"G D A E":["G2","D3","A3","E4"]},
  mandolin:{"G D A E":["G3","D4","A4","E5"]},
  bouzouki:{"G D A E":["G2","D3","A3","E4"]}
};
let inst="guitar",A4=440;

function noteHz(n,A){const m=/^([A-G])(#?)(-?\d+)$/.exec(n);
const base={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[m[1]],s=m[2]?1:0,o=+m[3];
const i=base+s+(o+1)*12,a4=9+(4+1)*12;return A*Math.pow(2,(i-a4)/12);}

function fillA4(){
a4Select.innerHTML="";for(let v=436;v<=446;v++){const o=document.createElement('option');
o.value=v;o.textContent=v;if(v===440)o.selected=true;a4Select.appendChild(o);}a4Show.textContent="A4="+A4;}
fillA4();

function fillTunings(){
tuningSelect.innerHTML="";for(const t in TUNINGS[inst]){
const o=document.createElement('option');o.value=t;o.textContent=t;tuningSelect.appendChild(o);}
tuningSelect.value=Object.keys(TUNINGS[inst])[0];updateStrings();}
fillTunings();

function updateStrings(){
const arr=TUNINGS[inst][tuningSelect.value];
tuningText.textContent=arr.map(x=>x.replace(/\d+/,"")).join(" ");
stringRow.innerHTML="";
arr.forEach(n=>{const d=document.createElement('div');d.className='string-chip';d.textContent=n.replace(/\d+/,"");stringRow.appendChild(d);});
}

tray.addEventListener('click',e=>{
const b=e.target.closest('button');if(!b)return;
[...tray.children].forEach(x=>x.classList.remove('active'));
b.classList.add('active');inst=b.dataset.inst;fillTunings();});

tuningSelect.addEventListener('change',updateStrings);
a4Select.addEventListener('change',()=>{A4=parseInt(a4Select.value);a4Show.textContent="A4="+A4;});

let ctx=null,analyser=null,stream=null,buf=new Float32Array(4096),run=false;
toggleBtn.onclick=async()=>{
if(run){stopMic();return;}
try{
stream=await navigator.mediaDevices.getUserMedia({audio:true});
ctx=new AudioContext();analyser=ctx.createAnalyser();analyser.fftSize=4096;
const src=ctx.createMediaStreamSource(stream);src.connect(analyser);
run=true;toggleBtn.textContent="Stop Mic";micStatus.textContent="Mic On";loop();
}catch(e){statusEl.textContent="Mic error";}
};

function stopMic(){
run=false;if(stream)stream.getTracks().forEach(t=>t.stop());
if(ctx)ctx.close();toggleBtn.textContent="Start Mic";micStatus.textContent="Mic Off";pointer.style.left="50%";
}

function yin(b,sr){const N=b.length;const tmin=2,tmax=Math.min(Math.floor(sr/50),N-1);
const d=new Float32Array(tmax+1);for(let t=tmin;t<=tmax;t++){let s=0;for(let i=0;i<N-t;i++){const v=b[i]-b[i+t];s+=v*v;}d[t]=s;}
const cmnd=new Float32Array(tmax+1);let rs=0;for(let t=tmin;t<=tmax;t++){rs+=d[t];cmnd[t]=d[t]*t/(rs||1);}
let tau=-1;for(let t=tmin+1;t<=tmax;t++){if(cmnd[t]<0.1&&cmnd[t]<cmnd[t-1]){tau=t;break;}}if(tau<0)return-1;
return sr/tau;}

function loop(){
if(!run)return;analyser.getFloatTimeDomainData(buf);
let sum=0;for(let i=0;i<buf.length;i++)sum+=buf[i]*buf[i];
levelBar.style.width=Math.min(100,sum*60000)+"%";
const hz=yin(buf,ctx.sampleRate);if(hz>0){const n=Math.round(12*Math.log2(hz/A4))+69;
const name=NOTE_NAMES[(n%12+12)%12];noteEl.textContent=name;pointer.style.left=((Math.log2(hz/noteHz(name+"4",A4))*1200/50+50))+"%";}
requestAnimationFrame(loop);
}

/* metronome */
let mctx=null,mtimer=null,count=0;
function pattern(sig){if(sig==="6-8")return{p:6,a:new Set([0,3])};
if(sig==="3-4")return{p:3,a:new Set([0])};
if(sig==="2-4")return{p:2,a:new Set([0])};
return{p:4,a:new Set([0])};}
function dots(){metroDots.innerHTML="";const {p}=pattern(sigSelect.value);
for(let i=0;i<p;i++){const d=document.createElement('div');d.className="dot";metroDots.appendChild(d);}}
dots();sigSelect.onchange=dots;
function beat(ac){if(!mctx)mctx=new AudioContext();
const t=mctx.currentTime+0.01,o=mctx.createOscillator(),g=mctx.createGain();
o.type="square";o.frequency.value=ac?1200:900;g.gain.value=ac?0.15:0.1;o.connect(g);g.connect(mctx.destination);
o.start(t);o.stop(t+0.05);}
function startM(){if(mtimer)return;const {p,a}=pattern(sigSelect.value);
const bpm=Math.max(30,Math.min(240,parseInt(bpmInput.value)||100));
const dur=60000/bpm;count=0;
mtimer=setInterval(()=>{const ac=a.has(count%p);beat(ac);
[...metroDots.children].forEach((d,i)=>{d.className="dot"+(i===count%p?" active":"")+(ac&&i===count%p?" accent":"");});
count++;},dur);metroBtn.textContent="Stop";}
function stopM(){if(mtimer){clearInterval(mtimer);mtimer=null;}
if(mctx){mctx.close();mctx=null;}[...metroDots.children].forEach(d=>d.className="dot");metroBtn.textContent="Metronome";}
metroBtn.onclick=()=>mtimer?stopM():startM();
})();
</script>
</body>
</html>

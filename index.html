<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Ceol Gan Eagla â€” Chromatic Tuner (Dark, No Frequency)</title>
<meta name="theme-color" content="#0b1220"/>
<link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%230b1220"/><path d="M12 32h40" stroke="%23a4b0c0" stroke-width="6" stroke-linecap="round"/><circle cx="32" cy="32" r="8" fill="%23a4f2b5"/></svg>'/>

<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --card:#0c1324; --ink:#eaf2ff; --muted:#a4b0c0; --line:#1f2a44;
    --ok:#22c55e; --low:#ff8a1f; --high:#ef4444; --bar:#111a2e; --bar-edge:#1a2744; --glow:0 10px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .wrap{display:grid;grid-template-rows:auto auto auto 1fr auto;gap:12px;min-height:100dvh;padding:14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:clamp(18px,4.5vw,28px);letter-spacing:.3px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{
    appearance:none;border:1px solid var(--line);background:var(--panel);color:var(--ink);
    padding:10px 14px;border-radius:14px;font-weight:700;cursor:pointer;box-shadow:var(--glow)
  }
  button.toggle.start{background:#16a34a;color:white;border-color:#106c31}
  button.toggle.stop{background:#b91c1c;color:white;border-color:#7f1212}
  .badge{padding:8px 12px;border-radius:999px;background:var(--panel);border:1px solid var(--line);font-weight:700;color:var(--muted)}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:12px;box-shadow:var(--glow)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}

  /* Preserved logo space (image removed but space kept) */
  .logo-space{height:52px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--line);border-radius:14px;background:var(--card);color:var(--muted);font-size:12px}

  /* Instrument chips */
  .tray{display:flex;flex-wrap:wrap;gap:8px}
  .instrument-btn{
    display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;
    background:var(--card);border:1px solid var(--line);cursor:pointer;font-weight:800;color:var(--ink)
  }
  .instrument-btn.active{outline:2px solid #3b82f6}
  .instrument-btn.tuned{background:#0e2919;border-color:#1f8a4e;}

  /* Tuning bar */
  .bar-wrap{display:grid;gap:12px}
  .bar{
    position:relative;height:36px;border-radius:999px;background:var(--bar);
    border:1px solid var(--bar-edge);box-shadow:inset 0 0 0 1px rgba(255,255,255,.02), var(--glow);
    overflow:hidden;
  }
  .bar .zone.low{position:absolute;left:0;top:0;bottom:0;width:50%;background:linear-gradient(90deg, rgba(255,138,31,.18), rgba(255,138,31,0));}
  .bar .zone.high{position:absolute;right:0;top:0;bottom:0;width:50%;background:linear-gradient(270deg, rgba(239,68,68,.18), rgba(239,68,68,0));}
  .bar .zone.ok{position:absolute;left:50%;transform:translateX(-50%);top:0;bottom:0;width:12%;background:linear-gradient(90deg, rgba(34,197,94,.3), rgba(34,197,94,.0) 60%);}
  .pointer{
    position:absolute;top:50%;transform:translate(-50%,-50%);
    width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:18px solid #eaf2ff;
    filter:drop-shadow(0 4px 8px rgba(0,0,0,.6));
  }
  .readout{display:grid;gap:6px;justify-items:center;text-align:center}
  .note{font-size:clamp(28px,10vw,48px);font-weight:900;letter-spacing:1px}
  /* removed .freq */
  .status{font-size:clamp(16px,4vw,22px);font-weight:900;padding:6px 12px;border-radius:12px;background:var(--card);border:1px solid var(--line);min-width:140px}
  .status.low{color:var(--low);box-shadow:0 0 0 2px rgba(255,138,31,.15) inset}
  .status.high{color:var(--high);box-shadow:0 0 0 2px rgba(239,68,68,.15) inset}
  .status.ok{color:var(--ok);box-shadow:0 0 0 2px rgba(34,197,94,.15) inset}
  .help{font-size:12px;color:var(--muted)}

  /* Background glow when tuned */
  .wrap.tuned{background: radial-gradient(1200px 400px at 50% -200px, rgba(34,197,94,.12), transparent 60%), var(--bg);}

  footer{margin-top:8px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <h1>Ceol Gan Eagla â€” Chromatic Tuner</h1>
    <div class="controls">
      <button id="toggleBtn" class="toggle start">Start Mic</button>
      <span class="badge" id="micStatus">Mic: Off</span>
    </div>
  </header>

  <!-- Space where <img src="logo.png"> used to be -->
  <div class="logo-space" aria-hidden="true">Logo space preserved (image hidden)</div>

  <div class="panel">
    <div class="row">
      <div class="tray" id="instrumentTray" aria-label="Choose instrument">
        <button class="instrument-btn active" data-inst="guitar" title="Guitar (EADGBE)">ðŸŽ¸<span>Guitar</span></button>
        <button class="instrument-btn" data-inst="violin" title="Violin (GDAE)">ðŸŽ»<span>Violin</span></button>
        <button class="instrument-btn" data-inst="tenorbanjo" title="Tenor Banjo (GDAE)">ðŸª•<span>Tenor Banjo</span></button>
        <button class="instrument-btn" data-inst="mandolin" title="Mandolin (GDAE)">ðŸŽ¶<span>Mandolin</span></button>
        <button class="instrument-btn" data-inst="bouzouki_gdae" title="Irish Bouzouki (GDAE)">ðŸŽ¶<span>Bouzouki GDAE</span></button>
        <button class="instrument-btn" data-inst="bouzouki_gdad" title="Irish Bouzouki (GDAD)">ðŸŽ¶<span>Bouzouki GDAD</span></button>
        <button class="instrument-btn" data-inst="ukulele" title="Ukulele (GCEA re-entrant)">ðŸŽµ<span>Ukulele</span></button>
        <button class="instrument-btn" data-inst="bass4" title="Bass (EADG)">ðŸŽ¸<span>Bass</span></button>
        <button class="instrument-btn" data-inst="viola" title="Viola (CGDA)">ðŸŽ»<span>Viola</span></button>
        <button class="instrument-btn" data-inst="cello" title="Cello (CGDA)">ðŸŽ»<span>Cello</span></button>
      </div>
      <span class="badge">Mode: Auto string detect</span>
    </div>
  </div>

  <div class="panel bar-wrap">
    <div class="bar" id="bar">
      <div class="zone low"></div>
      <div class="zone ok"></div>
      <div class="zone high"></div>
      <div class="pointer" id="pointer" style="left:50%"></div>
    </div>
    <div class="readout">
      <div class="note" id="note">â€”</div>
      <!-- frequency display removed -->
      <div class="status" id="status">Listeningâ€¦</div>
      <div class="help">Bar turns <b style="color:var(--ok)">green</b> when in tune; <span style="color:var(--low)">orange</span> = too low, <span style="color:var(--high)">red</span> = too high.</div>
    </div>
  </div>

  <footer>Â© 2025 GearÃ³id MacUaid â€” Ceol Gan Eagla</footer>
</div>

<script>
(() => {
  const A4 = 440;
  const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

  // Instruments
  const INSTRUMENTS = {
    guitar:       [{n:"E2",f:82.4069},{n:"A2",f:110.000},{n:"D3",f:146.832},{n:"G3",f:196.000},{n:"B3",f:246.942},{n:"E4",f:329.628}],
    violin:       [{n:"G3",f:196.000},{n:"D4",f:293.665},{n:"A4",f:440.000},{n:"E5",f:659.255}],
    tenorbanjo:   [{n:"G2",f:97.999},{n:"D3",f:146.832},{n:"A3",f:220.000},{n:"E4",f:329.628}],
    mandolin:     [{n:"G3",f:196.000},{n:"D4",f:293.665},{n:"A4",f:440.000},{n:"E5",f:659.255}],
    bouzouki_gdae:[{n:"G2",f:97.999},{n:"D3",f:146.832},{n:"A3",f:220.000},{n:"E4",f:329.628}],
    bouzouki_gdad:[{n:"G2",f:97.999},{n:"D3",f:146.832},{n:"A3",f:220.000},{n:"D4",f:293.665}],
    ukulele:      [{n:"G4",f:392.000},{n:"C4",f:261.626},{n:"E4",f:329.628},{n:"A4",f:440.000}],
    bass4:        [{n:"E1",f:41.2034},{n:"A1",f:55.000},{n:"D2",f:73.4162},{n:"G2",f:97.999}],
    viola:        [{n:"C3",f:130.813},{n:"G3",f:196.000},{n:"D4",f:293.665},{n:"A4",f:440.000}],
    cello:        [{n:"C2",f:65.4064},{n:"G2",f:97.999},{n:"D3",f:146.832},{n:"A3",f:220.000}],
  };

  // UI
  const appEl = document.getElementById('app');
  const toggleBtn = document.getElementById('toggleBtn');
  const micStatus = document.getElementById('micStatus');
  const tray = document.getElementById('instrumentTray');
  const pointer = document.getElementById('pointer');
  const bar = document.getElementById('bar');
  const noteEl = document.getElementById('note');
  const statusEl = document.getElementById('status');

  let currentInstrumentKey = 'guitar';

  // Audio chain
  let audioCtx=null, analyser=null, mediaStream=null;
  let hpFilter=null, lpFilter=null;
  const BUF_SIZE = 4096;
  let buf = new Float32Array(BUF_SIZE);
  let running=false;

  // Stability & smoothing
  let displayCents = 0;
  let lock = {active:false, stringIdx:-1, expires:0};
  let cand = {idx:-1, count:0};

  // Anti-wildness parameters
  const LEVEL_GATE = 0.012;    // RMS gate (silence/noise)
  const YIN_THRESH = 0.10;     // YIN absolute threshold (lower = stricter)
  const CONF_GATE  = 0.6;      // confidence gate
  const MIN_HZ=50, MAX_HZ=1200;
  const SMOOTH_A = 0.92;       // needle smoothing (EMA)
  const DEADBAND_CENTS = 1.5;  // ignore tiny jitter
  const LOCK_NEED_FRAMES = 14; // frames to lock a string
  const LOCK_TIME_MS = 6000;   // how long to hold lock
  const C_HISTORY = 7;         // length of cents history for median
  const centsHistory = [];

  tray.addEventListener('click', (e)=>{
    const btn = e.target.closest('.instrument-btn');
    if(!btn) return;
    [...tray.children].forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentInstrumentKey = btn.dataset.inst;
    lock = {active:false,stringIdx:-1,expires:0};
    cand = {idx:-1,count:0};
  });

  // Helpers
  function rms(arr){ let s=0; for(let i=0;i<arr.length;i++){const v=arr[i]; s+=v*v;} return Math.sqrt(s/arr.length); }
  function centsOff(f, ref){ return 1200 * Math.log2(f / ref); }
  function freqToNote(f){
    const n = Math.round(12 * Math.log2(f / A4)) + 57;
    const name = NOTE_NAMES[(n % 12 + 12) % 12];
    const octave = Math.floor(n / 12) - 1;
    return {name, octave};
  }
  function nearestStringIdx(hz, inst){
    let best = {idx:0, cents:Infinity};
    for (let i=0;i<inst.length;i++){
      const c = Math.abs(centsOff(hz, inst[i].f));
      if (c < best.cents) best = {idx:i, cents:c};
    }
    return best.idx;
  }
  function median(arr){
    const a = arr.slice().sort((x,y)=>x-y);
    const m = Math.floor(a.length/2);
    return a.length%2 ? a[m] : (a[m-1]+a[m])/2;
  }

  // ----------- YIN pitch detection -----------
  function yin(buf, sampleRate){
    const N = buf.length;
    const tauMax = Math.min(Math.floor(sampleRate / 50), N-1);
    const tauMin = Math.max(2, Math.floor(sampleRate / 1200));
    const d = new Float32Array(tauMax+1);
    for (let tau=tauMin; tau<=tauMax; tau++){
      let sum = 0;
      for (let i=0; i<N - tau; i++){
        const diff = buf[i] - buf[i+tau];
        sum += diff*diff;
      }
      d[tau] = sum;
    }
    const cmnd = new Float32Array(tauMax+1);
    let runningSum = 0;
    for (let tau=tauMin; tau<=tauMax; tau++){
      runningSum += d[tau];
      cmnd[tau] = d[tau] * tau / (runningSum || 1);
    }
    let tau = -1;
    for (let t=tauMin+1; t<=tauMax; t++){
      if (cmnd[t] < YIN_THRESH && cmnd[t] < cmnd[t-1]){
        tau = t;
        while (t+1 <= tauMax && cmnd[t+1] < cmnd[t]) { t++; tau = t; }
        break;
      }
    }
    if (tau === -1) return {hz:-1, conf:0};
    const t0 = Math.max(tau-1, tauMin), t1 = tau, t2 = Math.min(tau+1, tauMax);
    const s0 = cmnd[t0], s1 = cmnd[t1], s2 = cmnd[t2];
    const denom = (s0 - 2*s1 + s2);
    const shift = denom !== 0 ? (s0 - s2) / (2*denom) : 0;
    const tauEst = tau + shift;
    const conf = Math.max(0, 1 - cmnd[tau]);
    const hz = sampleRate / tauEst;
    if (!isFinite(hz) || hz<MIN_HZ || hz>MAX_HZ) return {hz:-1, conf:0};
    return {hz, conf};
  }

  function setPointerByCents(cents){
    const clamp = Math.max(-50, Math.min(50, cents));
    const delta = clamp - displayCents;
    if (Math.abs(delta) < DEADBAND_CENTS) return;
    displayCents = displayCents * SMOOTH_A + clamp * (1 - SMOOTH_A);
    const t = (displayCents + 50) / 100;
    pointer.style.left = (t*100) + "%";
  }

  async function start(){
    if (running) return;
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({
        audio:{ echoCancellation:false, noiseSuppression:false, autoGainControl:false, channelCount:1, sampleRate:48000 }
      });
    }catch(err){ alert("Microphone permission denied or unavailable.\n"+err); return; }

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // Band-pass filters to calm rumble/hiss
    hpFilter = audioCtx.createBiquadFilter(); hpFilter.type="highpass"; hpFilter.frequency.value=50;
    lpFilter = audioCtx.createBiquadFilter(); lpFilter.type="lowpass";  lpFilter.frequency.value=1800;

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = BUF_SIZE;
    analyser.smoothingTimeConstant = 0.06;

    const src = audioCtx.createMediaStreamSource(mediaStream);
    src.connect(hpFilter); hpFilter.connect(lpFilter); lpFilter.connect(analyser);

    running = true;
    toggleBtn.textContent = "Stop Mic";
    toggleBtn.classList.remove('start'); toggleBtn.classList.add('stop');
    micStatus.textContent = "Mic: On";

    loop();
  }

  function stop(){
    running = false;
    if (mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
    if (audioCtx){ audioCtx.close().catch(()=>{}); audioCtx=null; }
    analyser = hpFilter = lpFilter = null;
    toggleBtn.textContent = "Start Mic";
    toggleBtn.classList.remove('stop'); toggleBtn.classList.add('start');
    micStatus.textContent = "Mic: Off";
    statusEl.className = "status";
    statusEl.textContent = "Stopped";
    appEl.classList.remove('tuned');
    pointer.style.left = "50%";
    displayCents = 0;
    centsHistory.length = 0;
    lock = {active:false,stringIdx:-1,expires:0};
    cand = {idx:-1,count:0};
  }

  toggleBtn.addEventListener('click', () => running ? stop() : start());
  document.addEventListener('visibilitychange', () => { if (document.hidden && running) stop(); });

  function loop(){
    if (!running || !analyser) return;

    analyser.getFloatTimeDomainData(buf);
    const sr = audioCtx.sampleRate || 48000;

    if (rms(buf) < LEVEL_GATE){
      statusEl.className = "status";
      statusEl.textContent = "Listeningâ€¦";
      appEl.classList.remove('tuned');
      requestAnimationFrame(loop);
      return;
    }

    const {hz, conf} = yin(buf, sr);

    if (hz > 0 && conf > CONF_GATE){
      const inst = INSTRUMENTS[currentInstrumentKey];
      let idx = nearestStringIdx(hz, inst);

      if (!lock.active){
        if (cand.idx === idx) cand.count++; else { cand.idx=idx; cand.count=1; }
        if (cand.count > LOCK_NEED_FRAMES){ lock={active:true,stringIdx:idx,expires:performance.now()+LOCK_TIME_MS}; cand={idx:-1,count:0}; }
      } else {
        if (performance.now() > lock.expires){ lock={active:false,stringIdx:-1,expires:0}; }
        else { idx = lock.stringIdx; }
      }

      const ref = inst[idx].f;
      let cents = 1200 * Math.log2(hz / ref);
      centsHistory.push(cents); if (centsHistory.length > C_HISTORY) centsHistory.shift();
      cents = median(centsHistory);

      setPointerByCents(cents);
      const note = freqToNote(hz);
      noteEl.textContent = `${note.name}${note.octave}`;

      const abs = Math.abs(cents);
      let cls = "status", txt = "";
      if (abs <= 5){ cls+=" ok"; txt="In Tune"; appEl.classList.add('tuned'); bar.style.boxShadow="inset 0 0 0 2px rgba(34,197,94,.35), var(--glow)"; }
      else if (cents < 0){ cls+=" low"; txt="Too Low"; appEl.classList.remove('tuned'); bar.style.boxShadow="inset 0 0 0 2px rgba(255,138,31,.25), var(--glow)"; }
      else { cls+=" high"; txt="Too High"; appEl.classList.remove('tuned'); bar.style.boxShadow="inset 0 0 0 2px rgba(239,68,68,.25), var(--glow)"; }
      statusEl.className = cls; statusEl.textContent = txt;

      // Chip highlight when the locked string is in tune
      [...tray.children].forEach((btn,i)=> btn.classList.toggle('tuned', (lock.active && i === lock.stringIdx && abs <= 5)));

    } else {
      statusEl.className = "status";
      statusEl.textContent = "Listeningâ€¦";
      appEl.classList.remove('tuned');
      setPointerByCents(displayCents * 0.95);
    }

    requestAnimationFrame(loop);
  }
})();
</script>
</body>
</html>

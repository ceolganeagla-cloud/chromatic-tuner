<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>Ceol Gan Eagla — Tuner v2.12</title>
<meta name="theme-color" content="#0b1117"/>
<link rel="icon" href="logo.png" type="image/png">
<link rel="manifest" href="manifest.json">
<style>
:root{
  --brand-green:#144e2a; --brand-green-2:#0e3a20; --brand-gold:#d7b54a;
  --flag-g:#169b62; --flag-o:#ff883e;
  --bg:#0d1621; --panel:#0f1f2e; --ink:#f4f8fb; --muted:#a9bbcf; --line:#24394d;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
background:radial-gradient(120% 120% at 10% 0%,#142437 0,var(--bg) 40%,#09121b 100%)}
header{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(10,16,24,.65);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
.badge{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:10px;background:linear-gradient(180deg,var(--brand-green),var(--brand-green-2));border:1px solid #23673f}
.logo{width:36px;height:36px;border-radius:6px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.35);background:#0a2415;border:1px solid #2a7446;display:grid;place-items:center}
.logo img{width:100%;height:100%;object-fit:cover;display:block}
.name{font-weight:800;letter-spacing:.4px;background:linear-gradient(180deg,#fff7c0,var(--brand-gold));-webkit-background-clip:text;color:transparent}
.flag{display:inline-block;width:22px;height:14px;border-radius:3px;border:1px solid #2b3d4d;margin-left:2px;background:linear-gradient(90deg,var(--flag-g) 0 33%,#fff 33% 66%,var(--flag-o) 66% 100%)}
header .grow{flex:1}
button{background:#0a1622;color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:10px 14px;font-weight:800;transition:filter .15s}
button.primary{background:linear-gradient(180deg,#1b8a45,#176e39);border-color:#2b7b4b}
button.live{background:linear-gradient(180deg,#ef4444,#c52828);border-color:#8f1d1d;color:#fff}
button:disabled{opacity:.6;filter:grayscale(.2);cursor:not-allowed}
main{max-width:1100px;margin:0 auto;padding:14px;display:grid;gap:14px}
.board{display:grid;grid-template-columns:1fr;gap:14px}@media(min-width:980px){.board{grid-template-columns:1.3fr .7fr}}
.card{background:linear-gradient(180deg,var(--panel),#0c1a28);border:1px solid var(--line);border-radius:20px;padding:14px}
.stage{width:100%;aspect-ratio:16/11;background:#0a1722;border:1px solid var(--line);border-radius:16px}
.controls{display:grid;gap:12px}
.a4row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.a4pill{border:1px solid var(--line);background:#0a1622;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800}
.a4pill.active{background:rgba(34,197,94,.12);border-color:#2a5f3b}
label{color:var(--muted);font-size:.9rem}
.legend{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:12px;flex-wrap:wrap}
.pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0a1622;color:#a9bbcf;font-weight:800}
.pill.ok{color:var(--ok);border-color:#2a5f3b;background:rgba(34,197,94,.12)}
.pill.flat{color:var(--warn);border-color:#745a19;background:rgba(245,158,11,.08)}
.pill.sharp{color:var(--bad);border-color:#6a1f1f;background:rgba(239,68,68,.08)}
/* Global tint for state */
#tint{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .2s ease;z-index:10}
body.stopped #tint{background:rgba(34,197,94,.14);opacity:1}
body.recording #tint{background:transparent;opacity:0}
/* Tap overlay */
#tapOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);z-index:30}
#tapOverlay .inner{background:linear-gradient(180deg,#0f2232,#0a1824);border:1px solid var(--line);color:var(--ink);padding:18px 16px;border-radius:16px;text-align:center;max-width:90%}
#tapOverlay .inner b{color:var(--brand-gold)}
/* Dial zones + glow */
.arc-warn{stroke:#f59e0b}
.arc-ok{stroke:#22c55e}
.arc-bad{stroke:#ef4444}
#tuneGlow{opacity:0;transition:opacity .18s ease}
#gauge.inTune #tuneGlow{opacity:1 !important}
/* Needle */
#needle{vector-effect:non-scaling-stroke;stroke-width:16}
#needleTip{filter:url(#glowG)}
/* Pulse when in tune */
#gauge.inTune { animation: pulse 1.2s ease-in-out infinite; }
@keyframes pulse { 0%,100%{transform:translate(600px,610px) scale(1)} 50%{transform:translate(600px,610px) scale(1.01)} }
/* Footer */
footer{margin:20px auto 40px;max-width:1100px;color:#a9bbcf;opacity:.9}
footer .ft{padding:10px 14px;border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,var(--panel),#0c1a28);text-align:center}
</style>
</head>
<body class="stopped">
<div id="tint"></div>

<header>
  <div class="badge">
    <div class="logo"><img src="logo.png" alt="Ceol Gan Eagla" onerror="this.remove()"></div>
    <div class="name">Ceol Gan Eagla</div><span class="flag" title="Éire"></span>
  </div>
  <div class="grow"></div>
  <button id="btnStart" class="primary">Start</button>
  <button id="btnStop" disabled>Stop</button>
</header>

<main>
  <section class="board">
    <div class="card">
      <svg id="stage" class="stage" viewBox="0 0 1200 825" xmlns="http://www.w3.org/2000/svg" aria-label="Instrument Tuner">
        <defs>
          <filter id="glowG"><feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          <linearGradient id="needleGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%"  stop-color="#f6d665"/><stop offset="100%" stop-color="#22ff8a"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="1200" height="825" rx="16" ry="16" fill="#0a1722" stroke="#223a53"/>
        <g id="silhouette"></g><g id="strings"></g>
        <g id="gauge" transform="translate(600,610)">
          <path class="arc-warn" d="M -380 0 A 380 380 0 0 1 -40 -375" fill="none" stroke-width="18" stroke-opacity=".85"/>
          <path class="arc-ok"   d="M -40 -375 A 380 380 0 0 1  40 -375" fill="none" stroke-width="20" stroke-opacity="1"/>
          <path class="arc-bad"  d="M  40 -375 A 380 380 0 0 1  380  0" fill="none" stroke-width="18" stroke-opacity=".85"/>
          <path d="M -380 0 A 380 380 0 0 1 380 0" fill="none" stroke="#1a3348" stroke-width="6"/>
          <g id="ticks"></g>
          <path id="tuneGlow" d="M -60 -372 A 380 380 0 0 1 60 -372" fill="none" stroke="#22c55e" stroke-opacity="0.9" stroke-width="24" filter="url(#glowG)"/>
          <line id="needle" x1="0" y1="0" x2="0" y2="-340" stroke="url(#needleGrad)" stroke-linecap="round" filter="url(#glowG)"/>
          <circle id="needleTip" cx="0" cy="-340" r="7" fill="#22ff8a"/>
          <circle cx="0" cy="0" r="12" fill="#0a1722" stroke="#2a4862" stroke-width="4"/><circle cx="0" cy="0" r="6" fill="#22ff8a" filter="url(#glowG)"/>
          <text id="noteLabel" x="0" y="90" text-anchor="middle" fill="#f4f8fb" font-size="64" font-weight="900">—</text>
          <text id="freqLabel" x="0" y="132" text-anchor="middle" fill="#9fb2c8" font-size="26" font-weight="800">0.00 Hz</text>
        </g>
      </svg>
      <div class="legend">
        <div id="status" class="pill">Stopped</div>
        <div id="a4read" class="pill">A4: 440 Hz</div>
      </div>
    </div>

    <div class="card controls">
      <div class="a4row" id="a4row">
        <label>Reference A4</label>
        <button class="a4pill" data-a4="440">440</button><button class="a4pill" data-a4="441">441</button>
        <button class="a4pill" data-a4="442">442</button><button class="a4pill" data-a4="443">443</button>
        <button class="a4pill" data-a4="444">444</button>
      </div>
      <div class="row">
        <label class="grow" for="instrument">Instrument</label>
        <select id="instrument" class="grow">
          <option value="guitar">Guitar</option><option value="violin">Violin</option><option value="mandolin">Mandolin</option>
          <option value="banjo5">Banjo (5-string)</option><option value="bouzouki">Irish Bouzouki</option><option value="bass">Bass</option>
        </select>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="ft">© Gearóid MacUaid — Ceol Gan Eagla — 2025</div>
</footer>

<!-- Tap gate -->
<div id="tapOverlay"><div class="inner">
  <div style="font-size:18px;margin-bottom:6px"><b>Tap to start the tuner</b></div>
  <div>Unlocks your microphone on mobile.</div>
  <div style="margin-top:10px"><button id="overlayStart" class="primary">Start</button></div>
</div></div>

<script>
/* ===== Basics ===== */
const statusPill=document.getElementById('status');
const btnStart=document.getElementById('btnStart'), btnStop=document.getElementById('btnStop');
const selInstrument=document.getElementById('instrument');
const a4Read=document.getElementById('a4read');
const NOTE_NAMES=["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"];
function f2n(f,A4=440){return 69+12*Math.log2(f/A4)}
function n2f(n,A4=440){return A4*Math.pow(2,(n-69)/12)}
function nameOf(n){const i=((Math.round(n)%12)+12)%12;return NOTE_NAMES[i]}
const TUNINGS={guitar:()=>[64,59,55,50,45,40],violin:()=>[76,69,62,55],mandolin:()=>[76,69,62,55],banjo5:()=>[67,62,59,55,50],bouzouki:()=>[62,57,50,43],bass:()=>[43,38,33,28]};
function tuningHz(name,A4){return TUNINGS[name]().map(m=>({midi:m,name:NOTE_NAMES[m%12]+(Math.floor(m/12)-1),freq:n2f(m,A4)}))}

/* ===== SVG refs ===== */
const gSil=document.getElementById('silhouette'), gStr=document.getElementById('strings'), gTicks=document.getElementById('ticks');
const gGauge=document.getElementById('gauge'), gNeedle=document.getElementById('needle'), gTip=document.getElementById('needleTip');
const noteLabel=document.getElementById('noteLabel'), freqLabel=document.getElementById('freqLabel');

/* Build ticks */
(function buildTicks(){gTicks.innerHTML='';for(let i=-50;i<=50;i+=5){const a=(-160)+(i+50)*320/100,r=a*Math.PI/180,inn=320,out=350;
const x1=Math.sin(r)*inn,y1=-Math.cos(r)*inn,x2=Math.sin(r)*(i%10===0?out:out-10),y2=-Math.cos(r)*(i%10===0?out:out-10);
const L=document.createElementNS('http://www.w3.org/2000/svg','line');L.setAttribute('x1',x1);L.setAttribute('y1',y1);L.setAttribute('x2',x2);L.setAttribute('y2',y2);
L.setAttribute('stroke','#253a4f');L.setAttribute('stroke-width',i%10===0?3:2);gTicks.appendChild(L);}})();

/* ===== Instrument drawing ===== */
let A4=440, currentInstrument=selInstrument.value, currentStrings=tuningHz(currentInstrument,A4), activeIdx=0;
function drawInstrument(){
  gSil.innerHTML=''; gStr.innerHTML='';
  const p=document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('fill','#0e2233'); p.setAttribute('stroke','#2a4862'); p.setAttribute('stroke-width','3');
  if(['guitar','bass','bouzouki','mandolin'].includes(currentInstrument)){
    p.setAttribute('d','M120 160 q40 -50 120 -70 h300 q70 20 120 70 v240 q-50 60 -120 80 H240 q-80 -18 -120 -80z');
  }else if(currentInstrument==='banjo5'){
    p.setAttribute('d','M120 170 q40 -45 120 -60 h280 q90 18 130 70 v210 q-40 70 -130 95 H240 q-80 -20 -120 -85 z M320 240 h40 v40 h-40z');
  }else{
    p.setAttribute('d','M150 150 q60 -60 140 -70 h260 q60 15 110 60 v250 q-50 55 -110 80 H290 q-80 -14 -140 -70z');
  }
  gSil.appendChild(p);
  const N=currentStrings.length, topY=210, botY=360;
  for(let i=0;i<N;i++){
    const y=topY+(i*(botY-topY)/(N-1||1));
    const peg=document.createElementNS('http://www.w3.org/2000/svg','circle');
    peg.setAttribute('cx','560'); peg.setAttribute('cy',y); peg.setAttribute('r','12'); peg.setAttribute('fill','#1b2a3a'); peg.setAttribute('stroke','#2f4357');
    peg.style.cursor='pointer'; peg.addEventListener('click',()=>setActive(i)); gSil.appendChild(peg);
    const s=document.createElementNS('http://www.w3.org/2000/svg','line');
    s.setAttribute('x1','190'); s.setAttribute('y1',y); s.setAttribute('x2','560'); s.setAttribute('y2',y);
    s.setAttribute('stroke','#95b2cc'); s.setAttribute('stroke-width',i===0?3:2); s.setAttribute('data-idx',i);
    s.style.cursor='pointer'; s.addEventListener('click',()=>setActive(i)); gStr.appendChild(s);
    const lab=document.createElementNS('http://www.w3.org/2000/svg','text');
    lab.setAttribute('x','180'); lab.setAttribute('y',y+7); lab.setAttribute('text-anchor','end'); lab.setAttribute('fill','#cfe0f3'); lab.setAttribute('font-weight','800'); lab.setAttribute('font-size','20');
    lab.textContent=currentStrings[i].name; lab.style.cursor='pointer'; lab.addEventListener('click',()=>setActive(i)); gStr.appendChild(lab);
  }
  const nut=document.createElementNS('http://www.w3.org/2000/svg','rect'); nut.setAttribute('x','188'); nut.setAttribute('y',topY-18);
  nut.setAttribute('width','6'); nut.setAttribute('height',(botY-topY)+36); nut.setAttribute('fill','#2e3f52'); gStr.appendChild(nut);
  highlightString();
}
function setActive(i){activeIdx=i;highlightString()}
function highlightString(){gStr.querySelectorAll('line[data-idx]').forEach((ln,i)=>{if(i===activeIdx){ln.setAttribute('stroke','#22c55e');ln.setAttribute('stroke-width','4');ln.setAttribute('filter','url(#glowG)')}else{ln.setAttribute('stroke','#95b2cc');ln.setAttribute('stroke-width',i===0?3:2);ln.removeAttribute('filter')}})}
function rebuildInstrument(){currentStrings=tuningHz(currentInstrument,A4);drawInstrument()}
selInstrument.addEventListener('change',()=>{currentInstrument=selInstrument.value;activeIdx=0;rebuildInstrument()});
rebuildInstrument();

/* ===== A4 pills ===== */
const a4row=document.getElementById('a4row');
function setA4(v){A4=v; a4Read.textContent='A4: '+v+' Hz'; rebuildInstrument(); highlightA4()}
function highlightA4(){a4row.querySelectorAll('.a4pill').forEach(b=>b.classList.toggle('active',+b.dataset.a4===A4))}
a4row.addEventListener('click',(e)=>{const b=e.target.closest('.a4pill'); if(!b) return; setA4(+b.dataset.a4)});
setA4(440);

/* ===== Pitch engine ===== */
let audioCtx=null, analyser=null, source=null, stream=null, running=false, buf=null, rafId=null;
const MAXF=5000, MIN_RMS=0.006, MIN_CONF=0.78, BIAS_SEMITONES=2, TUNE_WINDOW=5;
let displayedAngle = 0, havePitch = false;
const isAndroid = /Android/i.test(navigator.userAgent);

function initAnalyser(){analyser=audioCtx.createAnalyser();analyser.fftSize=2048;analyser.minDecibels=-90;analyser.maxDecibels=-10;analyser.smoothingTimeConstant=0.85;buf=new Float32Array(analyser.fftSize)}
function detectPitch(buf,sr){
  const N=buf.length;
  let mean=0; for(let i=0;i<N;i++) mean+=buf[i]; mean/=N;
  let rms=0;
  for(let i=0;i<N;i++){ const w=0.5*(1-Math.cos(2*Math.PI*i/(N-1))); const v=(buf[i]-mean)*w; buf[i]=v; rms+=v*v; }
  rms=Math.sqrt(rms/N); if(rms<MIN_RMS) return {f:-1,conf:0,rms};
  const MIN_F=50, MAX_F=1500, minLag=Math.floor(sr/MAX_F), maxLag=Math.min(Math.floor(sr/MIN_F),N-3);
  let bestLag=-1, bestCorr=0;
  for(let lag=minLag;lag<=maxLag;lag++){
    let corr=0,n1=0,n2=0;
    for(let i=0;i<N-lag;i++){ const a=buf[i], b=buf[i+lag]; corr+=a*b; n1+=a*a; n2+=b*b; }
    const c=corr/((Math.sqrt(n1*n2))||1);
    if(c>bestCorr){bestCorr=c;bestLag=lag;}
  }
  if(bestLag<=0) return {f:-1,conf:0,rms};
  return {f:sr/bestLag,conf:bestCorr,rms};
}
const hist=[], HN=7;
function median(a){const s=[...a].sort((x,y)=>x-y);const m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2}
function nearestTarget(f){let best=null,bd=1e9;currentStrings.forEach(s=>{const d=Math.abs(1200*Math.log2(f/s.freq));if(d<bd){bd=d;best=s}});return {t:best,d:bd}}

function loop(){
  if(!running) return;
  analyser.getFloatTimeDomainData(buf);
  const d=detectPitch(buf,audioCtx.sampleRate);
  if(d.f>0 && d.f<MAXF && d.conf>=MIN_CONF){
    havePitch = true;
    let f=d.f; const near=nearestTarget(f);
    if(near && near.t && near.d <= BIAS_SEMITONES*100) f=near.t.freq*0.2 + f*0.8;
    hist.push(f); if(hist.length>HN) hist.shift();
    const smooth = hist.length>=3 ? median(hist) : f;

    const nn=f2n(smooth,A4), nR=Math.round(nn);
    const noteName=nameOf(nR)+(Math.floor(nR/12)-1);
    const noteFreq=n2f(nR,A4);
    const cents=Math.round(1200*Math.log2(smooth/noteFreq));

    noteLabel.textContent=noteName;
    freqLabel.textContent=smooth.toFixed(2)+' Hz';

    const lim=50, c=Math.max(-lim,Math.min(lim,cents));
    const targetAngle = (-160)+(c+50)*320/100;
    displayedAngle = displayedAngle*0.85 + targetAngle*0.15;
    gNeedle.setAttribute('transform','rotate('+displayedAngle+')');
    gTip.setAttribute('transform','rotate('+displayedAngle+')');

    if(c > TUNE_WINDOW) gTip.setAttribute('fill','#ff7a7a');
    else if(c < -TUNE_WINDOW) gTip.setAttribute('fill','#ffd07a');
    else gTip.setAttribute('fill','#22ff8a');
  }
  rafId = requestAnimationFrame(loop);
}

function setRunningUI(on){
  if(on){
    btnStart.disabled=true; btnStart.classList.add('live'); btnStart.textContent='Listening…';
    btnStop.disabled=false; document.body.classList.remove('stopped'); document.body.classList.add('recording');
    statusPill.textContent='Listening';
  }else{
    btnStart.disabled=false; btnStart.classList.remove('live'); btnStart.textContent='Start';
    btnStop.disabled=true; document.body.classList.remove('recording'); document.body.classList.add('stopped');
    statusPill.textContent='Stopped'; gGauge.classList.remove('inTune');
  }
}

/* ===== Start/Stop with Android workarounds ===== */
const tapOverlay=document.getElementById('tapOverlay'), overlayStart=document.getElementById('overlayStart');
['click','touchend'].forEach(evt=>{
  btnStart.addEventListener(evt,start,{passive:true});
  overlayStart.addEventListener(evt,start,{passive:true});
});
btnStop.addEventListener('click', stop);
['beforeunload','pagehide','freeze'].forEach(ev=>window.addEventListener(ev, stop, {passive:true}));
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stop(); }, {passive:true});

let shadowAudioEl=null;
async function start(){
  try{
    tapOverlay.style.display='none';
    audioCtx=new (window.AudioContext||window.webkitAudioContext)({sampleRate:44100});
    if(audioCtx.state==='suspended') await audioCtx.resume();

    const streamOpts={audio:{channelCount:1,echoCancellation:false,noiseSuppression:false,autoGainControl:false,sampleRate:44100},video:false};
    stream=await navigator.mediaDevices.getUserMedia(streamOpts);

    // Ephemeral hidden audio element (created fresh each start)
    shadowAudioEl=document.createElement('audio');
    shadowAudioEl.autoplay=true; shadowAudioEl.muted=true; shadowAudioEl.playsInline=true; shadowAudioEl.style.display='none';
    document.body.appendChild(shadowAudioEl);
    shadowAudioEl.srcObject=stream;

    source=audioCtx.createMediaStreamSource(stream);
    initAnalyser(); source.connect(analyser);

    running=true; havePitch=false; displayedAngle=0; setRunningUI(true);
    gNeedle.setAttribute('transform','rotate(0)'); gTip.setAttribute('transform','rotate(0)');
    rafId = requestAnimationFrame(loop);
  }catch(err){ console.error(err); statusPill.textContent='Mic error'; }
}

async function stop(){
  if(!running && !stream && !audioCtx){ setRunningUI(false); return; }
  running=false;
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }

  try{ if(stream){ stream.getTracks().forEach(t=>{ try{t.stop();}catch{} }); } }catch{}
  try{ if(source){ source.disconnect(); } }catch{}
  try{ if(analyser){ analyser.disconnect(); } }catch{}
  try{ if(audioCtx){ await audioCtx.close(); } }catch{}

  // Detach and remove the hidden audio element
  try{ if(shadowAudioEl){ shadowAudioEl.pause(); shadowAudioEl.srcObject=null; shadowAudioEl.remove(); shadowAudioEl=null; } }catch{}

  stream=null; source=null; analyser=null; audioCtx=null; buf=null; havePitch=false;
  setRunningUI(false);

  // Android-only: reacquire-and-immediately-stop to reset OS mic ownership
  if(isAndroid && navigator.mediaDevices?.getUserMedia){
    try{
      const tmp=await navigator.mediaDevices.getUserMedia({audio:true,video:false});
      tmp.getTracks().forEach(t=>t.stop());
    }catch(e){ /* ignore */ }
  }
}
</script>
</body>
</html>
